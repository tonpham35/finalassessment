<p>Symbol: <%= @investment.symbol %></p>
<p>Cost($): <%= @investment.cost %>
<p>Closing Price($): <span id="closingPriceSpan"><img src="/assets/kloader.gif" id='loader'></span></p>
<p>Day Change($): <span id="dayChange$"><img src="/assets/kloader.gif" id='loader'></span></p>
<p>Day Change(%): <span id="dayChange%"><img src="/assets/kloader.gif" id='loader'></span></p>
<p>Quantity(#): <%= @investment.quantity %></p>
<p>Market Value($): <span id="marketValue$"><img src="/assets/kloader.gif" id='loader'></span></p>
<p>Gain($): <span id="gain$"><img src="/assets/kloader.gif" id='loader'></span></p>
<p>Gain(%): <span id="gain%"><img src="/assets/kloader.gif" id='loader'></span></p>

<div style="height: 10%; width: 50%;">
<canvas id="myChart" width="100%" height="100"></canvas>
</div>
<script>
  $(document).ready(function() {

    <% days = (DateTime.now.to_date - @investment.purchasedate.to_s.split(' ')[0].to_date).to_i %>
    <% if days > 135 %>
      <% size = "full" %>
    <% else %>
      <% size = "compact" %>
    <% end %>

    console.log(<%= days %>)

    var requestURL = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=<%= @investment.symbol %>&outputsize=<%= size %>&apikey=N6WB2563ACVSGIJV';

    var request = new XMLHttpRequest();

    request.open('GET', requestURL);

    request.responseType = 'json';

    request.send();

    request.onload = function() {
      var api = request.response;
      var dates = Object.keys(api["Time Series (Daily)"]);

      var start = "<%= @investment.purchasedate.to_s.split(' ')[0] %>";

      var label = [];
      var datapoints = [];
      var date;
      var points;

      var i = 0;
      while (date != start) {
        date = dates[i];
        points = api["Time Series (Daily)"][date]["4. close"]*<%= @investment.quantity %>;
        label.push(date);
        datapoints.push(points)
        i++;
      }

      var closingPrice = api["Time Series (Daily)"][dates[0]]["4. close"];
      var openingPrice = api["Time Series (Daily)"][dates[0]]["1. open"];

      var dayChangeDollar = closingPrice - openingPrice; 
      var dayChangePercent = (dayChangeDollar / openingPrice) * 100;
      var marketValue = closingPrice * <%= @investment.quantity %>
      document.getElementById("closingPriceSpan").innerHTML = closingPrice;
      document.getElementById("dayChange$").innerHTML = dayChangeDollar.toFixed(3);
      document.getElementById("dayChange%").innerHTML = dayChangePercent.toFixed(3);
      document.getElementById("marketValue$").innerHTML = marketValue.toFixed(2);
      document.getElementById("gain$").innerHTML = (marketValue.toFixed(2) - <%= @investment.cost %>) * 100;
      document.getElementById("gain%").innerHTML = (100 * (( marketValue.toFixed(2) - <%= @investment.cost %> ) / <%= @investment.cost %>)).toFixed(3);

      var canvas = document.getElementById('myChart');

      var data = {
          labels: label.reverse(),
          datasets: [
              {
                  label: "<%= @investment.symbol %> Performance",
                  fill: true,
                  lineTension: 0.1,
                  backgroundColor: "rgba(75,192,192,0.4)",
                  borderColor: "rgba(75,192,192,1)",
                  borderCapStyle: 'butt',
                  borderDash: [],
                  borderDashOffset: 0.0,
                  borderJoinStyle: 'miter',
                  pointBorderColor: "rgba(75,192,192,1)",
                  pointBackgroundColor: "#fff",
                  pointBorderWidth: 1,
                  pointHoverRadius: 5,
                  pointHoverBackgroundColor: "rgba(75,192,192,1)",
                  pointHoverBorderColor: "rgba(220,220,220,1)",
                  pointHoverBorderWidth: 2,
                  pointRadius: 0,
                  pointHitRadius: 10,
                  data: datapoints.reverse()
              }]
      };

      var option = {
        showLines: true
      };
      var myLineChart = Chart.Line(canvas,{
        data:data,
        options:option
      });


    }
  });

</script>

<%= link_to 'Edit', edit_investment_path(@investment) %> |
<%= link_to 'Back', investments_path %>
